# Code for extracting relevant values from CSV file created by Matlab Code
# Currently two different outputs - CSV file with columns of relevant values, XLSX spreadsheet combining original CSV with relevant values

# Need to figure out how to alter the time values in the CSV BEFORE running this code to alter the CSV

import csv
import pandas as pd
from datetime import datetime, timedelta

# Replace with name of CSV file to be manipulated
tmsFile='/Users/ashleypelton/Downloads/timing-rest-8blocks-60-101723 - Sheet1.csv'

# Columns of relevant data to be obtained from initial CSV
TMSColumn = []
TTLCounter = []
TotalTTL = []
Blocks = []
TimeStamp = []
Time = []

# Iterates through the current CSV, pulling relevant data
pulse = 1
with open(tmsFile, mode='r') as file:
    reader = csv.reader(file)
    for row in reader:
        if row[0] == "t":
            Blocks.append("ON")
        elif row[0] == ">>>":
            if row[1] == "t":
                Blocks.append("OFF")
        elif row[0] == "PULSE!":
            Blocks.append("OFF")
        for i in range(len(row)):
            if row[i] == 'Timestamp:':
                if i + 1 < len(row):
                    strTime = row[i+1]
                    timeFormat = "%H:%M:%S"
                    """Will need to add .%f later"""
                    numTime = datetime.strptime(strTime, timeFormat)
                    """Need to format numTime differently"""
                    TimeStamp.append(strTime)
                    if len(TimeStamp) != 0:
                        initial = datetime.strptime(TimeStamp[0], timeFormat)
                        Time.append((numTime - initial).total_seconds())
                    else:
                        Time.append(numTime - numTime)
            elif row[i] == 'TTL:':
                if i + 1 < len(row):
                    TTLCounter.append(row[i + 1])
                    TotalTTL.append(pulse)
                    pulse += 1
                    TMSColumn.append('N')
            elif row[i] == 'TMS:':
                if i + 1 < len(row):
                    TMSColumn.append('Y')
                    TTLCounter.append('P')
                    TotalTTL.append('P')

# Initial CSV converted to a DF for the combined CSV file
df1 = pd.read_csv(tmsFile)

# Relevant data values separated into columns
data = { 'TMS (Y/N)' : TMSColumn,
         'TTL Counter' : TTLCounter,
         'Total TTL' : TotalTTL,
         'Blocks' : Blocks,
         'Timestamp' : TimeStamp,
         'Time/Duration (Seconds)' : Time}
df2 = pd.DataFrame(data)
  
# Creates combined CSV file
df2.to_csv('updatedCSV.csv', index=False) # Need updated name

# Creates xlsx file with two sheets
with pd.ExcelWriter('combined.xlsx', engine='openpyxl') as writer: # Need updated name
    df1.to_excel(writer, sheet_name='Initial CSV', index=False)
    df2.to_excel(writer, sheet_name='All Values', index=False)